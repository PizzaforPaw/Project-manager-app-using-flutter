import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';

class AllProjectsScreen extends StatefulWidget {
  const AllProjectsScreen({super.key});

  @override
  State<AllProjectsScreen> createState() => _AllProjectsScreenState();
}

class _AllProjectsScreenState extends State<AllProjectsScreen> {
  // 1. DATA SOURCES
  List<Map<String, dynamic>> inWorkProjects = [
    {
      "id": "1",
      "tag": "testing new project",
      "tagColor": Colors.amber,
      "title": "testing hard",
      "description": "I don't know what is this anymore",
      "progressCurrent": 4,
      "progressTotal": 10,
      "priority": "highly",
      "avatars": ['https://i.pravatar.cc/150?img=11', 'https://i.pravatar.cc/150?img=3'],
    },
    {
      "id": "2",
      "tag": "Dev",
      "tagColor": Colors.amber,
      "title": "I don't know what I'm doing",
      "description": "this is for testing description",
      "progressCurrent": 4,
      "progressTotal": 10,
      "priority": "Very needed",
      "avatars": ['https://i.pravatar.cc/150?img=3', 'https://i.pravatar.cc/150?img=11'],
    },
  ];

  List<Map<String, dynamic>> completedProjects = [
     {
      "id": "3",
      "tag": "Design",
      "tagColor": Colors.blueAccent,
      "title": "App Redesign",
      "description": "Redoing the main dashboard screen",
      "progressCurrent": 10,
      "progressTotal": 10,
      "priority": "Urgent",
      "avatars": ['https://i.pravatar.cc/150?img=5', 'https://i.pravatar.cc/150?img=9'],
    },
  ];

  // 2. LOGIC TO MOVE ITEMS
  void _moveProject(Map<String, dynamic> project, bool toCompleted) {
    setState(() {
      if (toCompleted) {
        // Move TO Completed
        if (!completedProjects.any((p) => p['id'] == project['id'])) {
          inWorkProjects.removeWhere((p) => p['id'] == project['id']);
          completedProjects.insert(0, project); 
        }
      } else {
        // Move TO In Work
        if (!inWorkProjects.any((p) => p['id'] == project['id'])) {
          completedProjects.removeWhere((p) => p['id'] == project['id']);
          inWorkProjects.insert(0, project); 
        }
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: const Color(0xFFF9F9FB),
      appBar: AppBar(
        backgroundColor: Colors.transparent,
        elevation: 0,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back_ios, color: Colors.black, size: 20),
          onPressed: () => Navigator.pop(context),
        ),
        title: Text("Ayzek's project", style: GoogleFonts.poppins(color: Colors.black, fontWeight: FontWeight.bold, fontSize: 18)),
        actions: [
          IconButton(onPressed: () {}, icon: const Icon(Icons.person_add_alt, color: Colors.grey)),
          IconButton(onPressed: () {}, icon: const Icon(Icons.more_horiz, color: Colors.grey)),
        ],
      ),
      body: SingleChildScrollView(
        padding: const EdgeInsets.all(24),
        child: Column(
          children: [
            // 3. IN WORK SECTION
            _buildSectionHeader("IN WORK", inWorkProjects.length),
            const SizedBox(height: 10),
            _buildDropZoneList(inWorkProjects, isCompletedZone: false),

            const SizedBox(height: 30),

            // 4. COMPLETED SECTION
            _buildSectionHeader("COMPLETED", completedProjects.length),
            const SizedBox(height: 10),
            _buildDropZoneList(completedProjects, isCompletedZone: true),
            
            // Extra space at bottom so FAB doesn't cover content
            const SizedBox(height: 80), 
          ],
        ),
      ),
      
      // Floating Action Button
      floatingActionButton: FloatingActionButton(
        onPressed: () {},
        backgroundColor: const Color(0xFF5B67CA),
        shape: const CircleBorder(),
        child: const Icon(Icons.add, size: 30),
      ),
      floatingActionButtonLocation: FloatingActionButtonLocation.centerDocked,
      
      // Bottom Bar
      bottomNavigationBar: BottomAppBar(
        shape: const CircularNotchedRectangle(),
        notchMargin: 8.0,
        child: SizedBox(
          height: 60,
          child: Row(
            mainAxisAlignment: MainAxisAlignment.spaceAround,
            children: [
              IconButton(icon: const Icon(Icons.home, color: Color(0xFF5B67CA)), onPressed: () {}),
              IconButton(icon: const Icon(Icons.list_alt, color: Colors.grey), onPressed: () {}),
              const SizedBox(width: 40),
              IconButton(icon: const Icon(Icons.message_outlined, color: Colors.grey), onPressed: () {}),
              IconButton(icon: const Icon(Icons.settings_outlined, color: Colors.grey), onPressed: () {}),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSectionHeader(String title, int count) {
    return Row(
      children: [
        Text(title, style: GoogleFonts.poppins(color: Colors.grey, fontWeight: FontWeight.bold, fontSize: 14)),
        const SizedBox(width: 10),
        Container(
          padding: const EdgeInsets.symmetric(horizontal: 8, vertical: 2),
          decoration: BoxDecoration(color: Colors.grey[300], borderRadius: BorderRadius.circular(10)),
          child: Text("$count", style: GoogleFonts.poppins(fontSize: 12, fontWeight: FontWeight.bold, color: Colors.grey[700])),
        )
      ],
    );
  }

  // 5. THE DROP ZONE (The list area itself detects drops)
  Widget _buildDropZoneList(List<Map<String, dynamic>> projects, {required bool isCompletedZone}) {
    return DragTarget<Map<String, dynamic>>(
      onWillAccept: (data) => true,
      onAccept: (project) {
        _moveProject(project, isCompletedZone);
      },
      builder: (context, candidateData, rejectedData) {
        bool isHovering = candidateData.isNotEmpty;

        return Container(
          // Ensure the container has height even if empty so you can drop into it
          constraints: const BoxConstraints(minHeight: 150),
          width: double.infinity,
          decoration: BoxDecoration(
            color: isHovering ? Colors.blue.withOpacity(0.05) : Colors.transparent,
            borderRadius: BorderRadius.circular(20),
            border: isHovering || projects.isEmpty 
              ? Border.all(color: Colors.grey.withOpacity(0.3), style: BorderStyle.solid) // Dashed border effect for empty/hover
              : null,
          ),
          child: projects.isEmpty
              ? Center(child: Text("Drop here", style: GoogleFonts.poppins(color: Colors.grey.withOpacity(0.5))))
              : Column(
                  children: projects.map((project) => _buildDraggableCard(project)).toList(),
                ),
        );
      },
    );
  }

  Widget _buildDraggableCard(Map<String, dynamic> project) {
    return LongPressDraggable<Map<String, dynamic>>(
      data: project,
      dragAnchorStrategy: pointerDragAnchorStrategy,
      feedback: Material(
        color: Colors.transparent,
        child: SizedBox(
          width: MediaQuery.of(context).size.width * 0.9, // Width of card while dragging
          child: Opacity(
            opacity: 0.9,
            child: _buildDetailedProjectCard(project, isDragging: true),
          ),
        ),
      ),
      childWhenDragging: Opacity(
        opacity: 0.3,
        child: _buildDetailedProjectCard(project),
      ),
      child: _buildDetailedProjectCard(project),
    );
  }

  Widget _buildDetailedProjectCard(Map<String, dynamic> project, {bool isDragging = false}) {
    return Container(
      margin: const EdgeInsets.only(bottom: 20),
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(20),
        boxShadow: isDragging 
          ? [BoxShadow(color: const Color(0xFF5B67CA).withOpacity(0.4), blurRadius: 20, offset: const Offset(0, 10))] 
          : [BoxShadow(color: Colors.black.withOpacity(0.05), blurRadius: 15, offset: const Offset(0, 5))],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Row(
            children: [
              Container(
                padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 6),
                decoration: BoxDecoration(color: project['tagColor'], borderRadius: BorderRadius.circular(20)),
                child: Text(project['tag'], style: GoogleFonts.poppins(color: Colors.white, fontSize: 12, fontWeight: FontWeight.w600)),
              ),
              const Spacer(),
              const Icon(Icons.more_horiz, color: Colors.grey),
            ],
          ),
          const SizedBox(height: 15),
          Text(project['title'], style: GoogleFonts.poppins(fontSize: 18, fontWeight: FontWeight.bold, color: Colors.black)),
          const SizedBox(height: 5),
          Text(project['description'], style: GoogleFonts.poppins(fontSize: 14, color: Colors.grey)),
          const SizedBox(height: 20),
          Row(mainAxisAlignment: MainAxisAlignment.spaceBetween, children: [Text("Progress", style: GoogleFonts.poppins(fontWeight: FontWeight.w600)), Text("${project['progressCurrent']}/${project['progressTotal']}", style: GoogleFonts.poppins(fontWeight: FontWeight.w600))]),
          const SizedBox(height: 8),
          ClipRRect(borderRadius: BorderRadius.circular(10), child: LinearProgressIndicator(value: project['progressCurrent'] / project['progressTotal'], minHeight: 6, color: const Color(0xFF4AC1A0), backgroundColor: const Color(0xFFF0F0F0))),
          const SizedBox(height: 20),
          Row(children: [
             const Icon(Icons.notifications_none, size: 18, color: Colors.grey),
             const SizedBox(width: 4), 
             const Text("4", style: TextStyle(color: Colors.grey, fontSize: 12)), 
             const SizedBox(width: 10), 
             const Icon(Icons.attach_file, size: 18, color: Colors.grey), 
             const SizedBox(width: 4), 
             const Text("2", style: TextStyle(color: Colors.grey, fontSize: 12)), 
             const Spacer(),
             if (project['avatars'] != null)
                SizedBox(width: 50, height: 30, child: Stack(children: [Positioned(left: 0, child: CircleAvatar(radius: 14, backgroundImage: NetworkImage(project['avatars'][0]))), if((project['avatars'] as List).length > 1) Positioned(left: 18, child: CircleAvatar(radius: 14, backgroundImage: NetworkImage(project['avatars'][1])))]))
          ]),
        ],
      ),
    );
  }
}